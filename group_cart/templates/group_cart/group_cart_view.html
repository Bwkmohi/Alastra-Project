{% extends "group_cart/base.html" %}
    {% block group_con %}
    {% load humanize %}
     <title>
      سبد گروهی {{ group.group_name }} 
     </title>
   

  <div class="w-full">
      <h3 class="md:text-4xl text-2xl font-bold m-2 text-center bg-gradient-to-l from-[#0bffffcc] text-transparent bg-clip-text">
          {{ group.group_name }} سبد خرید گروهی  
            
          </p>
      </h3>
  </div>
  
  {% if user_carts %} 
  <div class="w-full py-8 px-4" dir="ltr">
    <div class="max-w-4xl mx-auto relative flex justify-between items-center text-center">
  
      <!-- خط زمینه -->
      <div class="absolute top-1/2 left-0 w-full h-1 bg-gradient-to-r from-[#062441] via-[#0b1421] to-[#062441] z-0 rounded-full shadow-inner"></div>
  
      <!-- مرحله 1 - کامل‌شده -->
      <div class="z-10 flex flex-col items-center w-1/3">
        <div class="w-10 h-10 bg-[#0d4370] text-white flex items-center justify-center rounded-full font-bold shadow-md ring-4 ring-[#b0bfd1]/40 transition-all duration-500">
          1
        </div>
        <p class="mt-2 text-sm font-semibold text-white drop-shadow">سبد خرید</p>
      </div>
  
      <!-- مرحله 2 - جاری -->
      <div class="z-10 flex flex-col items-center w-1/3">
        <div class="w-10 h-10 bg-[#062441] text-white flex items-center justify-center rounded-full font-bold ring-4 ring-[#0bffffcc] animate-pulse shadow-lg transition-all duration-500">
          2
        </div>
        <p class="mt-2 text-sm font-semibold text-[#0bffffcc] drop-shadow">اطلاعات ارسال</p>
      </div>
  
      <!-- مرحله 3 - آینده -->
      <div class="z-10 flex flex-col items-center w-1/3">
        <div class="w-10 h-10 bg-gray-400 text-white flex items-center justify-center rounded-full font-bold shadow-sm transition-all duration-500">
          3  
        </div>
        <p class="mt-2 text-sm font-semibold text-gray-300">پرداخت</p>
      </div>
  
    </div>
  </div>

<div class="bg-gradient-to-r from-[#062441] via-[#0bffffcc] to-[#0bffffcc] py-2 px-4 rounded-xl w-full shadow-2xl"></div>
<div class="min-h-screen bg-[#0b1421] flex md:flex-row flex-col md:justify-between gap-y-4 md:gap-0 p-4 pb-24">

  <div class="space-y-4 overflow-y-auto w-full md:w-2/3 relative">
    
    {% for user, carts in user_carts.items %}
      {% for pr in carts %}
        <div class="bg-gradient-to-r from-[#062441] via-[#0b1421] to-[#062441] mt-2 rounded-xl shadow-md flex items-center p-4 relative">
          <div class="w-1/3">
            <img src="{{ pr.product.image.url }}" alt="محصول" class="rounded-lg w-full object-cover">
          </div>
          <div class="w-2/3 px-4 flex flex-col justify-between">
            <ul role="list" class="divide-y divide-gray-200 dark:divide-gray-700">
              <li class="py-3 sm:py-4">
                <div class="flex items-center">
                  <div class="shrink-0">
                    <img class="w-8 h-8 rounded-full" src="https://api.dicebear.com/7.x/initials/svg?seed={{ request.user.username }}" alt="">
                  </div>
                  <div class="flex-1 min-w-0 ms-4">
                    <p class="text-sm font-medium text-gray-900 truncate dark:text-white" title="{{ user.first_name }} ,{{ user.last_name }}">
                      {{ user.username }}
                    </p>
                  </div>
                </div>
              </li>
            </ul>
            <div class="font-bold text-[#ffff] text-md mb-1">
              {{ pr.product.name }} <span>{{ pr.product_|intcomma  }}</span>
            </div>

            <div class="flex items-center space-x-2 rtl:space-x-reverse">
              <button class="bg-[#b0bfd1] text-[#ffff] w-8 h-8 rounded-full delete-btn" data-msg-id="{{ pr.id }}">-</button>
              <span class="font-bold text-[#ffff]" id="productQuantity">{{ pr.quantity }}</span>
              <button class="bg-[#b0bfd1] text-[#ffff] w-8 h-8 rounded-full add-btn" data-msg-id="{{ pr.id }}">+</button>

              <div class="relative inline-block text-left">
                <button type="button" class="menu-button text-[#ffff] text-2xl font-bold px-2" aria-haspopup="true" aria-expanded="false">
                  ⋮
                </button>

                <div class="menu hidden origin-top-right absolute right-0 mt-2 w-36 rounded-md shadow-lg bg-[#062441] ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                  <div class="py-1">
                    <a href="{% url 'group_c:remove_user_from_group' user.id group.id %}" class="block px-4 py-2 text-sm text-[#ffff] hover:bg-[#0b1421] w-full text-left">حذف کاربر</a>
                    <a href="{% url 'group_c:remove_product_from_cart' group.id pr.id %}" class="block px-4 py-2 text-sm text-[#ffff] hover:bg-[#0b1421] w-full text-left">حذف محصول</a>
                    <a href="{% url 'group_c:group_member_cart' group.id user.id %}" class="block px-4 py-2 text-sm text-[#ffff] hover:bg-[#0b1421] w-full text-left">مشاهده سبد خرید کاربر</a>
                  </div>
                </div>
              </div>
 
            </div>
          </div>
        </div>
      {% endfor %}
    {% endfor %}
  </div>

  <div class="bg-gradient-to-r from-[#0b1421] via-[#062441] to-[#062441] mt-2 mx-2 p-4 w-full md:w-1/3 rounded-xl shadow-lg space-y-3">
    {% for i in cost_fee %}
    <div class="flex justify-between text-sm text-[#ffff]">
      <span>{{ i.title }} :</span>
      <span>{{ i }}</span>
    </div>
    {% endfor %}

    <div class="flex justify-between text-sm text-[#ffff]">
      <span> تعداد محصولات:</span>
      <span>{{ qty }}</span>
    </div>        
    <div class="flex justify-between text-lg font-bold text-[#ffff]">
      <span>جمع نهایی:</span>
      <span style="color: green;" class="font-extrabold">{{ total_price }}</span>
    </div>
    <div class="flex flex-col gap-2 mt-4">
      <a href="{% url 'res:reservation_with_group_cart' group.id %}" class="bg-[#0bffffcc] text-[#ffff] text-center py-3 rounded-lg font-bold shadow-md hover:bg-[#0bffff] transition">اقدام به پرداخت</a>
      <a href="#" id="openModalBtn" class="border border-[#0bffffcc] text-[#ffff] text-center py-3 rounded-lg font-bold hover:bg-[#f0fdfa] transition inline-block">
          افزودن عضو
      </a>
      <button id="openMembersBtn" class="border border-[#0bffffcc] text-[#ffff] text-center py-3 rounded-lg font-bold hover:bg-[#f0fdfa] transition">لیست اعضا</button>
      <a href="{% url 'group_c:get_export_from_cart' group.id %}" class="border border-[#0bffffcc] text-[#ffff] text-center py-3 rounded-lg font-bold hover:bg-[#f0fdfa] transition">Get Exel</a>
    </div>
  </div>
</div>

<script>
  // اسکریپت باز و بسته کردن منوی سه نقطه‌ای
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.menu-button');

    buttons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.stopPropagation();

        // بقیه منوها رو ببند
        document.querySelectorAll('.menu').forEach(menu => {
          if(menu !== button.nextElementSibling){
            menu.classList.add('hidden');
          }
        });

        // باز و بسته کردن منو مربوط به دکمه کلیک شده
        const menu = button.nextElementSibling;
        menu.classList.toggle('hidden');
      });
    });

    // وقتی بیرون منو کلیک شد همه منوها بسته بشن
    document.addEventListener('click', () => {
      document.querySelectorAll('.menu').forEach(menu => menu.classList.add('hidden'));
    });
  });
</script>

</div>

<div class="fixed bottom-14 md:bottom-0 left-0 right-0 bg-[#062441] text-[#b0bfd1] flex justify-around items-center h-16 shadow-inner z-50 px-4">
  <a href="{% url 'res:reservation_with_group_cart' group.id %}" class="bg-[#0bffffcc] text-center w-2/3 text-[#ffff] py-3 rounded-lg font-bold shadow-md hover:bg-[#0bffff] transition">اقدام به پرداخت <i class="bi bi-credit-card ml-2"></i></a>
  <a href="{% url 'products_list' %}" class="border w-1/3 border-[#0bffffcc] text-center text-[#ffff] py-3 rounded-lg font-bold hover:bg-[#f0fdfa] transition">ادامه خرید <i class="bi bi-handbag"></i></a>
</div>


  
 
{% else %}
<div class="min-h-[70vh] flex flex-col items-center justify-center text-center text-[#b0bfd1] space-y-4">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-20 h-20 text-[#0bffffcc]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
      d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.2 6H19M7 13L5.4 5M16 17a2 2 0 100 4 2 2 0 000-4zm-8 0a2 2 0 100 4 2 2 0 000-4z" />
  </svg>
  <h2 class="text-2xl font-bold text-white drop-shadow">سبد خرید گروه {{ group.group_name }} شما خالی است</h2>
  <p class="text-sm text-[#b0bfd1]">هنوز محصولی به سبد خرید اضافه نشده است</p>
  <a href="{% url 'products_list' %}" class="mt-4 bg-[#0bffffcc] hover:bg-[#0bffff] text-[#0b1421] font-bold py-2 px-6 rounded-lg shadow-md transition">
    مشاهده محصولات
  </a>
  <div class="text-center mt-6">
  <button id="openMembersBtn" class="bg-[#0bffffcc] text-[#0b1421] font-bold py-2 px-6 rounded-lg shadow-md hover:bg-[#0bffff] transition">
    مشاهده اعضای گروه
  </button>
</div>
</div>
{% endif %}


          
 
<!-- مودال نمایش اعضای گروه -->
<div id="membersModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
  <div class="bg-[#0b1421] rounded-lg shadow-lg w-11/12 max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto">
    
    <!-- دکمه بستن -->
    <button id="closeMembersBtn" class="absolute top-3 right-3 text-[#0bffffcc] hover:text-[#0bffff] text-2xl font-bold">&times;</button>

    <h3 class="text-2xl font-bold mb-6 text-center text-white">اعضای گروه {{ group.group_name }}</h3>

    {% if user_carts %}
      <div class="space-y-4">
        {% for user__ in user_carts %}
        <div class="flex items-center justify-between p-4 rounded-lg bg-[#062441] shadow-md">
          <div class="flex items-center space-x-3 rtl:space-x-reverse">
            <img src="https://api.dicebear.com/7.x/initials/svg?seed={{ user__.username }}" alt="avatar"
                 class="w-10 h-10 rounded-full bg-gray-100 shadow-md">
            <div>
              <p class="text-white font-bold">{{ user__.first_name }} {{ user__.last_name }}</p>
              <p class="text-sm text-[#b0bfd1]">{{ user__.username }}</p>
            </div>
          </div>
          <div class="flex space-x-2 rtl:space-x-reverse">
            <a href="{% url 'group_c:group_member_cart' group.id user__.id %}"
               class="bg-[#0bffffcc] text-[#0b1421] font-bold px-3 py-1 rounded-md hover:bg-[#0bffff] transition text-sm">
              مشاهده سبد
            </a>
            <form method="post" action="">
              {% csrf_token %}
              <a href="{% url 'group_c:remove_user_from_group' user__.id group.id %}"
                class="bg-red-600 text-white font-bold px-3 py-1 rounded-md hover:bg-red-700 transition text-sm">
                حذف
            </a>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>

    {% else %}
      <p class="text-center text-gray-400">هیچ عضوی در گروه وجود ندارد.</p>
    {% endif %}

  </div>
</div>
 

<div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
  <div class="bg-gradient-to-br from-[#0b1421] via-[#062441] to-[#071927dd] rounded-2xl shadow-lg max-w-5xl w-full mx-4 p-8 relative">
    
    <!-- دکمه بستن مودال -->
    <button id="closeModalBtn" class="absolute top-4 right-4 text-[#0bffffcc] hover:text-[#0bffffee] text-2xl font-bold">&times;</button>
    
    <!-- فرم داخل مودال -->
    <form action="{% url 'group_c:add_users_to_group' group.id %}" method="POST" class="mx-auto max-w-5xl px-6 py-8">
        {% csrf_token %}
        <div class="mb-6">
            <label for="user_id" class="block mb-2 font-bold text-[#0bffffcc] text-lg select-none">شناسه کاربری</label>
            <input 
                id="user_id" 
                type="number" 
                name="user_id" 
                required 
                placeholder="شناسه کاربر را وارد کنید"
                class="w-full px-5 py-3 rounded-xl border-2 border-[#0bffffcc] bg-[#071927dd] placeholder-[#84a9bb] text-white font-semibold
                focus:outline-none focus:ring-4 focus:ring-[#0bffffcc] transition duration-300"
            />
        </div>
        <button 
            type="submit" 
            class="w-full py-3 rounded-xl bg-[#0bffffcc] text-[#0b1421] font-extrabold hover:bg-[#0bffffee] active:scale-95 transition transform duration-300 shadow-md"
        >
            ارسال اطلاعات
        </button>  
    </form>

  </div>
</div>

<!-- جاوااسکریپت باز و بستن مودال -->
<script>
  const openModalBtn = document.getElementById('openModalBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const modal = document.getElementById('modal');

  openModalBtn.addEventListener('click', (e) => {
    e.preventDefault();
    modal.classList.remove('hidden');
  });

  closeModalBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  // بستن مودال با کلیک روی بک‌گراند
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
    }
  });
</script>

<script>
  document.getElementById('openMembersBtn').addEventListener('click', function () {
    document.getElementById('membersModal').classList.remove('hidden');
  });

  document.getElementById('closeMembersBtn').addEventListener('click', function () {
    document.getElementById('membersModal').classList.add('hidden');
  });

  document.getElementById('membersModal').addEventListener('click', function (e) {
    if (e.target === this) {
      this.classList.add('hidden');
    }
  });
</script>






 
<script>
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const mins_id = this.dataset.msgId;
      fetch("/cart/mines/", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `id=${mins_id}`
      })
      .then(res => res.json())
      .then(data => {
          if (data.success) {
            cartQuantity()
            document.getElementById('productQuantity').innerText = data.qty_mines
          } else if (data.error) {
  
          }
        });
    });
  });
</script>

<script>
  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const add_id = this.dataset.msgId;
      fetch("/cart/plus/", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `id=${add_id}`
      })
      .then(res => res.json())
        .then(data => {
          if (data.success) {
            cartQuantity()
            document.getElementById('productQuantity').innerText = data.qty_add
 
          } else if (data.error) {
  
          }
        });
    });
  });
</script> 
    {% endblock %}
