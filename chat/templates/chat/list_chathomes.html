{% extends 'chat/base.html' %}

{% block chat_content %}

<title>
    چت ها
</title>

<div class="min-h-screen bg-gradient-to-br from-[#0b1421] via-[#0b1421] to-[#041b2d]">
    
    <!-- هدر لیست چت -->
    <div class="border-b border-[#0bffff33] bg-gradient-to-b from-[#0b1421] to-[#0a1828]">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-gradient-to-br from-[#0bffff] to-[#0bffffee] rounded-2xl flex items-center justify-center">
                        <i class="bi bi-chat-dots text-2xl text-[#062441]"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-black bg-gradient-to-r from-[#0bffff] via-[#0bffffee] to-[#0bffffcc] bg-clip-text text-transparent">
                            پیام‌ها
                        </h1>
                        <p class="text-[#0bffffaa] mt-2">لیست تمام مکالمات شما</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="openModal()" class="bg-gradient-to-r from-[#0bffff33] to-[#0bffff11] border border-[#0bffff44] text-[#0bffff] px-4 py-2 rounded-xl hover:border-[#0bffff] hover:shadow-[0_0_15px_rgba(11,255,255,0.3)] transition-all duration-300 font-medium">
                        <i class="bi bi-plus-lg mr-2"></i>
                        چت جدید
                    </button>
                    <button id="openModalBtn" class="bg-gradient-to-r from-[#0bffff33] to-[#0bffff11] border border-[#0bffff44] text-[#0bffff] text-center px-4 py-2 rounded-xl hover:border-[#0bffff] hover:shadow-[0_0_15px_rgba(11,255,255,255,0.3)] transition-all duration-300 font-medium">
                        <i class="bi bi-gear mr-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- جستجو و فیلتر -->
    <div class="max-w-4xl mx-auto px-4 py-6">
        <div class="flex items-center gap-4">
            <div class="flex-1 relative">
                <input type="text" 
                       placeholder="جستجو در مکالمات..." 
                       class="w-full bg-[#0b1421aa] border-2 border-[#0bffff44] rounded-2xl px-6 py-4 text-white placeholder-[#0bffff66] focus:border-[#0bffff] focus:shadow-[0_0_20px_rgba(11,255,255,0.3)] outline-none transition-all duration-300 pr-12">
                <i class="bi bi-search absolute right-4 top-1/2 transform -translate-y-1/2 text-[#0bffffaa]"></i>
            </div>

        </div>
    </div>

<!-- مودال -->
<!-- مودال -->
<div id="modal" class="fixed inset-0 bg-[#0b1421cc] flex items-center justify-center hidden z-50">
  <div class="bg-gradient-to-br from-[#062441] to-[#0b1421] rounded-2xl p-6 w-full max-w-3xl border border-[#0bffff44] shadow-[0_0_30px_rgba(11,255,255,0.2)]">
    <h2 class="text-lg font-black mb-4 bg-gradient-to-r from-[#0bffff] via-[#0bffffee] to-[#0bffffcc] bg-clip-text text-transparent">
      کاربران مسدود شده
    </h2>
    <ul class="mb-6 space-y-3 max-h-60 overflow-y-auto text-[#0bffff] font-medium">
        {% for i in blocked_users %}
        <li class="flex justify-between items-center border border-[#0bffff33] p-3 rounded-xl bg-gradient-to-br from-[#06244188] to-[#0b142188]">
            <span>{{ i.blocked_user.get_full_name }}</span>
            <a href="{% url 'remove_from_black_list' i.id %}" class="px-3 py-1 bg-gradient-to-r from-[#0bffff33] to-[#0bffff11] border border-[#0bffff44] rounded-xl hover:border-[#0bffff] hover:shadow-[0_0_15px_rgba(11,255,255,0.3)] transition-all duration-300 font-medium">
                لغو مسدودیت
            </a>
        </li>
      {% endfor %}
    </ul>
    <button id="closeModalBtn" class="w-full px-4 py-2 bg-gradient-to-r from-[#0bffff33] to-[#0bffff11] border border-[#0bffff44] text-[#0bffff] rounded-xl hover:border-[#0bffff] hover:shadow-[0_0_15px_rgba(11,255,255,0.3)] transition-all duration-300 font-medium">
      بستن
    </button>
  </div>
</div>

<script>
  const openModalBtn = document.getElementById('openModalBtn');
  const modal = document.getElementById('modal');
  const closeModalBtn = document.getElementById('closeModalBtn');

  openModalBtn.addEventListener('click', () => {
    modal.classList.remove('hidden');
  });

  closeModalBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });
</script>



    <!-- دسته‌بندی‌ها -->
    <div class="max-w-4xl mx-auto px-4 pb-6">
        <div class="flex items-center gap-3 overflow-x-auto">
            <form action="" method="GET">
                <input type="text" name="filter" value="all" hidden>
                <button class="bg-gradient-to-r from-[#0bffff33] to-[#0bffff11] border border-[#0bffff] text-[#0bffff] px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap">
                    همه
                </button>
            </form>

            <form action="" method="GET">
                <input type="text" name="filter" value="fav" hidden>
            <button type="submit" class="bg-gradient-to-r from-[#0bffff33] to-[#0bffff11] border border-[#0bffff44] text-[#0bffffaa] px-4 py-2 rounded-full text-sm font-medium hover:border-[#0bffff] hover:text-[#0bffff] transition-all duration-300 whitespace-nowrap">
                مورد علاقه ها
            </button>
            </form>
        </div>
    </div>

    <!-- لیست چت‌ها -->
    <div class="max-w-4xl mx-auto px-4 pb-8">
        <div class="space-y-3">
             {% for i in chathomes %}
            <div class="group bg-gradient-to-br from-[#06244188] to-[#0b142188] rounded-2xl p-4 border border-[#0bffff33] hover:border-[#0bffff] hover:shadow-[0_0_30px_rgba(11,255,255,0.2)] transition-all duration-500 cursor-pointer">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        {% if i.profile_image_url %}
                            <img src="{{ i.profile_image_url }}" class="w-14 h-14 rounded-2xl border-2 border-[#0bffff33] object-cover">
                        {% else %}
                            <i class="bi bi-person w-20 h-20 text-5xl rounded-2xl border-2 border-[#0bffff33]"></i>
                        {% endif %}
                        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-[#0b1421]"></div>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-lg font-black text-white group-hover:text-[#0bffff] transition-colors truncate">
                                {% if request.user.pk == i.sender_ch.pk %}
                                    <a href="{% url 'chat' i.receiver_ch.pk i.pk %}">
                                        {{ i.receiver_ch.get_full_name }}
                                    </a>
                                {% else %}
                                    <a href="{% url 'chat' i.sender_ch.pk i.pk %}">
                                        {{ i.sender_ch.get_full_name }}
                                    </a>
                                {% endif %}
                            </h3>
                             <span class="text-[#0bffffaa] text-xs whitespace-nowrap">{{ i.last_message.timestamp }}</span>
                        </div>
                        <div class="flex items-center gap-3 mb-2">
                            <i class="bi bi-box-seam text-[#0bffffaa] text-sm"></i>
                            <p class="text-[#0bffffaa] text-sm truncate flex-1">
                                {{ i.last_message.message }}
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[#0bffff66] text-xs">•</span>
                            <span class="text-[#0bffff66] text-xs">آخرین پیام شما</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- دکمه چت جدید -->
    <div class="fixed bottom-8 left-1/2 transform -translate-x-1/2">
        <button class="bg-gradient-to-r from-[#0bffff] via-[#0bffffee] to-[#0bffff] text-[#062441] font-black px-6 py-4 rounded-2xl shadow-2xl shadow-[#0bffff66] hover:shadow-[0_0_40px_rgba(11,255,255,0.8)] hover:scale-105 transition-all duration-500 flex items-center gap-3">
            <i class="bi bi-plus-lg text-lg"></i>
            چت جدید
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // مدیریت کلیک روی آیتم‌های چت
    const chatItems = document.querySelectorAll('.group');
    chatItems.forEach(item => {
        item.addEventListener('click', function() {
            // اینجا می‌تونید کاربر رو به صفحه چت هدایت کنید
            const userName = this.querySelector('h3').textContent;
            console.log('ورود به چت با:', userName);
            // window.location.href = `/chat/${userId}`;
        });
    });

    // مدیریت جستجو
    const searchInput = document.querySelector('input[type="text"]');
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        chatItems.forEach(item => {
            const userName = item.querySelector('h3').textContent.toLowerCase();
            const lastMessage = item.querySelector('p').textContent.toLowerCase();
            
            if (userName.includes(searchTerm) || lastMessage.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });

    // مدیریت فیلتر دسته‌بندی‌ها
    const filterButtons = document.querySelectorAll('button.whitespace-nowrap');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // حذف هایلایت از همه دکمه‌ها
            filterButtons.forEach(btn => {
                btn.classList.remove('border-[#0bffff]', 'text-[#0bffff]');
                btn.classList.add('border-[#0bffff44]', 'text-[#0bffffaa]');
            });
            
            // هایلایت دکمه انتخاب شده
            this.classList.remove('border-[#0bffff44]', 'text-[#0bffffaa]');
            this.classList.add('border-[#0bffff]', 'text-[#0bffff]');
            
            // اینجا می‌تونید فیلتر کردن آیتم‌ها رو پیاده‌سازی کنید
            const filterType = this.textContent.trim();
            console.log('فیلتر بر اساس:', filterType);
        });
    });

    // دکمه چت جدید
    const newChatBtn = document.querySelector('.bi-plus-lg').closest('button');
    newChatBtn.addEventListener('click', function() {
        // اینجا می‌تونید modal انتخاب کاربر رو باز کنید
        console.log('باز کردن modal چت جدید');
    });
});
</script>

<style>
/* استایل اسکرول بار برای دسته‌بندی‌ها */
.flex.overflow-x-auto::-webkit-scrollbar {
    height: 4px;
}

.flex.overflow-x-auto::-webkit-scrollbar-track {
    background: #0b1421;
}

.flex.overflow-x-auto::-webkit-scrollbar-thumb {
    background: #0bffff33;
    border-radius: 2px;
}

.flex.overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #0bffff66;
}

/* انیمیشن برای آیتم‌های چت */
@keyframes chatItemAppear {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.group {
    animation: chatItemAppear 0.3s ease-out;
}

.group:nth-child(2) { animation-delay: 0.1s; }
.group:nth-child(3) { animation-delay: 0.2s; }
.group:nth-child(4) { animation-delay: 0.3s; }
.group:nth-child(5) { animation-delay: 0.4s; }
</style>



 
 <div id="new_user_modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-gradient-to-br from-[#062441] to-[#0b1421] rounded-2xl p-6 w-full max-w-3xl border border-[#0bffff44] shadow-[0_0_30px_rgba(11,255,255,0.2)]"">
        <!-- دکمه بستن -->
        <button onclick="closeModal()" class="absolute top-2 left-2 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        
        <!-- فرم داخل مودال -->
        <form method="POST" action="{% url 'new_chat' %}">
            {% csrf_token %}
            <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">ساخت چت جدید</h2>
            <label class="block mb-2 text-sm text-gray-700 dark:text-gray-300">نام کاربری:</label>
            <input type="text" name="username" class="w-full px-4 py-3 rounded-xl border-2 border-[#0bffffcc] bg-[#071927dd] placeholder-[#84a9bb] focus:outline-none focus:ring-4 focus:ring-[#0bffffcc]" placeholder="نام کاربری دریافت کننده" required>
            
            <button type="submit" class="mt-4 w-full bg-cyan-500 text-white py-2 rounded-lg hover:bg-cyan-600 transition">
                ایجاد
            </button>
        </form>
    </div>
</div>

<script>
    function openModal() {
        document.getElementById('new_user_modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('new_user_modal').classList.add('hidden');
    }
</script>

{% endblock chat_content %}
    